name: flyway

on:
  push:
    branches: 
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      FLYWAY_USER: admin
      FLYWAY_PASSWORD: admin123
      FLYWAY_URL: jdbc:sqlserver://dbbid.cow6bvh9jwad.eu-west-1.rds.amazonaws.com:1433;authentication=sqlPassword;databaseName=dbBidWheels;encrypt=true;trustServerCertificate=true
      FLYWAY_CLEAN_DISABLED: false
      FLYWAY_LOCATIONS: "filesystem:./migrations/"
      FLYWAY_CONFIG_FILES: "filesystem:flyway.toml"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
 
      - name: Setup Flyway CLI
        run: |
          sudo apt update
          sudo apt install -y default-jre
          wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/10.7.2/flyway-commandline-10.7.2-linux-x64.tar.gz | tar xvz
          sudo ln -s $(pwd)/flyway-10.7.2/flyway /usr/local/bin/flyway
 
      - name: Flyway Baseline
        run: |
          flyway baseline \
            -url="${FLYWAY_URL}" \
            -user="${FLYWAY_USER}" \
            -password="${FLYWAY_PASSWORD}" \
            -schema="[dbo].[dbBidWheels]" \
            -configFiles="${FLYWAY_CONFIG_FILES}"
 
      - name: Flyway Migrate 
        run: |
          flyway migrate \
            -url="${FLYWAY_URL}" \
            -user="${FLYWAY_USER}" \
            -password="${FLYWAY_PASSWORD}" \
            -schema="[dbo].[dbBidWheels]" \
            -locations="${FLYWAY_LOCATIONS}"
